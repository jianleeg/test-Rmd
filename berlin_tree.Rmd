---
title: "Berlin Election 2016"
output:
  html_document:
    self_contained: false
    #toc: true
    #toc_depth: 4
---

### Berlin Voter's Map

On 18th September 2016, Berlin voted for the state elections. Using the library "leaflet", the results of the state election is visualised according to the voting areas. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
setwd("C:/Users/jianj/Documents/test-Rmd")

library(leaflet)
library(maptools)
library(dplyr)
library(sp)
library(rgdal)
library(caret)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# load data
vote_brief_urnen <- read.csv("data/AHWahl2016_Zweitstimmen_Unicode.csv", encoding = "UTF-8")

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# data understanding
# unique(result1$Wahlbezirksart) # there are 2 types of voters
# exclude briefwahl
result1 <- subset(vote_brief_urnen, Wahlbezirksart == "Urnenwahlbezirk" )


```

```{r fig.width=9, warning=FALSE, message=FALSE, echo=FALSE}
berlin_shape <- readOGR("data/geo/Berlin_shape/UWB.shp", layer = "UWB", encoding = "utf-8", verbose = FALSE)
berlin_map <- spTransform(berlin_shape, CRS("+init=epsg:4326"))

# create column for Winner
z <- apply(result1[18:43], 1, which.max)
result1$Winner <- as.factor(names(result1[18:43])[z])

# level of Winners are in the sequence: AfD CDU FDP GR?NE LINKE SPD

# create palette colour according to levels in sequence
pal <- colorFactor(c('#00ADEF',
                     '#000000',
                     '#FFED00',
                     '#58AB27',
                     '#8C3473',
                     '#F0001C'), 
                   result1$Winner)


                       

```


### How did Berlin vote? 

```{r warning=FALSE, message=FALSE, echo=FALSE}
library(rpart)
library(rpart.plot)
library(dplyr)
library(rattle)
library(caTools)
library(partykit)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
data_election <- read.csv('data/wahl-zweitstimmen.tsv', sep='\t') 
data_social <- read.csv('data/wahl-soziodemographisch.tsv', sep='\t')
data_tree <- full_join(data_election, data_social, by="id")

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Normalising the votes into percentages in each voting area 
data_tree[9:34] <- data_tree[9:34] / data_tree$Gueltige.Stimmen * 100
df <- data_tree

# create new social demographical variables
df2 <- mutate(df, Hartz4 = Einwohner.unter.65.in.SGB.II.2014/Einwohner.unter.65.Jahren.2014 * 100) %>% 
  mutate(Foreigner = Auslaender/Einwohner*100) %>% 
  mutate(Born_Berlin = Gebuertige.Berliner/Einwohner*100) %>% 
  mutate(Immigrant_background = Deutsche.18...Migrationshintergrund/Deutsche.18..*100) %>% 
  mutate(Retired = Deutsche....65/Deutsche*100) %>% 
  mutate(Basic_housing = Deutsche.18...Wohnlage.einfach/Deutsche.18..*100) %>% 
  mutate(Average_housing = Deutsche.18...Wohnlage.mittel/Deutsche.18..*100) %>% 
  mutate(Good_housing = Deutsche.18...Wohnlage.gut/Deutsche.18..*100) %>% 
  mutate(Refugees_percent = Fluechtlinge/Einwohner*100) %>% 
  mutate(Refugees_percent_immigrant_background = Fluechtlinge/Deutsche.18...Migrationshintergrund*100)

colnames(df2)[51] <- "EastWest"
df2$EastWest <- ifelse(df2$EastWest == "O", "East", "West")

# create column of the winning party 
z <- apply(df2[9:34], 1, which.max)
df2$Winner <- names(df2[9:34])[z]


```

Using the characteristics of voters in Berlin to plot the classification tree (rpart). This decision tree is firstly created using rpart, and then converted to a conditional inference tree using as.party function. 
```{r fig.width=16, fig.height=8, warning=FALSE, echo=FALSE}
var <- Winner ~ EastWest + Hartz4 + Foreigner + Born_Berlin + Immigrant_background + Retired + Basic_housing + Average_housing + Good_housing + Refugees_percent + Refugees_percent_immigrant_background

set.seed(16)
tree <- rpart(var, data=df2, method="class")
rparty.tree <- as.party(tree)

# Create colour scheme for the Winners
columncol2 <- c('#00ADEF',
                '#000000',
                '#58AB27',
                '#8C3473',
                '#F0001C')

plot(rparty.tree, terminal_panel=node_barplot(rparty.tree, 
                                     fill = columncol2, 
                                              ylines = 1.2,
                                              gap = 0.02,
                                              ymax = 1.0,
                                              gp = gpar(fontsize = 7)
                                     ))

```

This shows that if a voting area is in East Berlin, and has less than 9.071% of Retiree, the Winner of that area is Gruene, with a likelihood is more than 80%. However, the tree seems rather overfitted. Let's prune the tree, by selecting a tree size that has the least cross-validated error ("xerror"). 

Credit: The <a href="http://interaktiv.morgenpost.de/wahlsieg-formel-berlin/" target="_blank">voting classification tree</a> and the <a href="http://berlinwahlkarte2016.morgenpost.de/" target="_blank">voting map</a> were inspired by the <a href="http://www.morgenpost.de/" target="_blank">Berliner Morgenpost</a>, along with the <a href="https://gist.github.com/berlinermorgenpost/f7c59ef94d21c7c942150b64d5e3ba4d" target="_blank">voting tree data</a> as well as the <a href="https://gist.github.com/berlinermorgenpost/f7b98db3f8a215f34e1e4bc1b4f5a363" target="_blank">sociodemographic data</a>. 

Data source of Berlin vote results are found <a href="https://www.wahlen-berlin.de/home.asp" target="_blank">here</a>.

<a href="/berlin_map_tree_final_2opa_code.html">Click here for this page with the respective R code</a>. 

